services:

# =========================
  # Databases
  # =========================
  sql-server:
    image: ${MSSQL_IMAGE_NAME}
    container_name: sql-server
    restart: unless-stopped
    user: root
    volumes:
      - ./docker-volumes/sql-server/data:/var/opt/mssql/data
      - ./docker-volumes/sql-server/log:/var/opt/mssql/log
    ports:
      - ${MSSQL_PORT}:1433
    environment:
      SA_PASSWORD: ${MSSQL_PASSWORD}
      ACCEPT_EULA: "Y"
    networks:
      - progcoder_network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "${MSSQL_PASSWORD}" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgres-sql:
    image: ${POSTGRES_IMAGE_NAME}
    container_name: postgres-sql
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_MULTIPLE_DATABASES: ${POSTGRES_MULTIPLE_DATABASES}
    ports:
      - ${POSTGRES_PORT}:5432
    volumes:
      - ./docker-volumes/postgres-sql:/var/lib/postgresql/data
      - ./config/postgres-sql:/docker-entrypoint-initdb.d
    entrypoint: ["/bin/bash", "-c", "chmod +x /docker-entrypoint-initdb.d/*.sh && docker-entrypoint.sh postgres"]
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d postgres -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: ${MONGO_IMAGE_NAME}
    container_name: mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    ports:
      - ${MONGO_PORT}:27017
    volumes:
      - ./docker-volumes/mongodb:/data/db
    networks:
      - progcoder_network

  mysql:
    image: ${MYSQL_IMAGE_NAME}
    container_name: mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    ports:
      - ${MYSQL_PORT}:3306
    volumes:
      - ./docker-volumes/mysql:/var/lib/mysql
    networks:
      - progcoder_network

  # =========================
  # Storage / Object store
  # =========================
  minio:
    image: ${MINIO_IMAGE_NAME}
    container_name: minio
    command: server --console-address ":9001" /data
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_PROMETHEUS_AUTH_TYPE: public
    hostname: minio
    ports:
      - ${MINIO_API_PORT}:9000
      - ${MINIO_UI_PORT}:9001
    volumes:
      - ./docker-volumes/minio:/data
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =========================
  # Identity / Security
  # =========================
  keycloak:
    image: ${KEYCLOAK_IMAGE_NAME}
    container_name: keycloak
    restart: unless-stopped
    command:
      - start
    volumes:
      - ./config/keycloak/providers:/opt/keycloak/providers
    environment:
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: ${KEYCLOAK_PORT}
      KC_HOSTNAME_STRICT_BACKCHANNEL: false
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HEALTH_ENABLED: true
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-sql/keycloak_db # Use the database name from POSTGRES_MULTIPLE_DATABASES
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      WEBHOOK_URL: ${WEBHOOK_URL}
    ports:
      - ${KEYCLOAK_PORT}:8080
    depends_on:
      - postgres-sql
    networks:
      - progcoder_network

  # =========================
  # Cache / Messaging / Mail
  # =========================
  redis:
    image: ${REDIS_IMAGE_NAME}
    container_name: redis
    restart: unless-stopped
    ports:
      - ${REDIS_PORT}:6379
    command: redis-server --save 20 1 --loglevel warning --requirepass ${REDIS_PASSWORD}
    volumes: 
      - ./docker-volumes/redis:/data
    networks:
      - progcoder_network

  redisinsight:
    image: ${REDISINSIGHT_IMAGE_NAME:-redis/redisinsight:latest}
    container_name: redisinsight
    restart: unless-stopped
    ports:
      - ${REDISINSIGHT_PORT:-5540}:5540
    volumes:
      - ./docker-volumes/redisinsight:/data
    networks:
      - progcoder_network
    depends_on:
      - redis

  redisinsight-init:
    image: curlimages/curl:latest
    container_name: redisinsight-init
    restart: "no"
    depends_on:
      - redisinsight
      - redis
    networks:
      - progcoder_network
    volumes:
      - ./config/redisinsight/add_datasources.sh:/scripts/add_datasources.sh
    environment:
      REDISINSIGHT_HOST: redisinsight
      REDISINSIGHT_PORT: 5540
    user: root
    entrypoint: ["/bin/sh", "-c", "chmod +x /scripts/add_datasources.sh && /scripts/add_datasources.sh"]
  
  rabbitmq:
    image: ${RABBITMQ_IMAGE_NAME}
    container_name: rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - ${RABBITMQ_CONNECT_PORT}:5672
      - ${RABBITMQ_UI_PORT}:15672
      - ${RABBITMQ_METRICS_PORT}:15692
    volumes:
      - ./docker-volumes/rabbitmq:/var/lib/rabbitmq
      - ./config/rabbitmq/rabbitmq_enabled_plugins:/etc/rabbitmq/enabled_plugins
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 3

  mailhog:
    image: ${MAILHOG_IMAGE_NAME}
    container_name: mailhog
    restart: unless-stopped
    ports:
      - ${MAILHOG_SMTP_PORT}:1025
      - ${MAILHOG_WEB_UI}:8025
    networks:
      - progcoder_network

  # =========================
  # Search Engine
  # =========================
  elasticsearch:
    image: ${ELASTIC_IMAGE_NAME}
    container_name: elasticsearch
    restart: unless-stopped
    ports:
      - ${ELASTIC_PORT}:9200
    volumes:
      - ./docker-volumes/elasticsearch:/usr/share/elasticsearch/data
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      xpack.security.enabled: true
      discovery.type: single-node
      bootstrap.memory_lock: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:9200 | grep -qE '(200|401|403)' || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 60s

  # Elasticsearch Init - Configure disk watermark settings automatically
  elasticsearch-init:
    image: curlimages/curl:latest
    container_name: elasticsearch-init
    restart: "no"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - progcoder_network
    volumes:
      - ./config/elasticsearch/watermark_settings.sh:/scripts/watermark_settings.sh
    environment:
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_USER: elastic
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
    user: root
    entrypoint: ["/bin/sh", "-c", "chmod +x /scripts/watermark_settings.sh && /scripts/watermark_settings.sh"]

  # =========================
  # Admin / Ops
  # =========================
  portainer:
    image: ${PORTAINER_IMAGE_NAME}
    container_name: portainer
    restart: unless-stopped
    ports:
      - ${PORTAINER_PORT1}:9000
      - ${PORTAINER_PORT2}:9443
      - ${PORTAINER_PORT3}:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-volumes/portainer:/data
    networks:
      - progcoder_network

  # =====================================
  # Monitoring
  # =====================================
  prometheus:
    image: ${PROMETHEUS_IMAGE_NAME}
    container_name: prometheus
    restart: unless-stopped
    user: root
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - ${PROMETHEUS_PORT}:9090
    volumes:
      - ./config/prometheus:/etc/prometheus
      - ./docker-volumes/prometheus:/prometheus"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.config.file=/etc/prometheus/web.yml"
    networks:
      - progcoder_network

  grafana:
    image: ${GRAFANA_IMAGE_NAME}
    container_name: grafana
    restart: unless-stopped
    user: root
    ports:
      - ${GRAFANA_PORT}:3000
    volumes:
      - ./docker-volumes/grafana:/var/lib/grafana
      - ./config/grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./config/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./config/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      GF_INSTALL_PLUGINS: "flant-statusmap-panel,grafana-piechart-panel,grafana-exploretraces-app"
    networks:
      - progcoder_network

  cadvisor:
    image: ${CADVISOR_IMAGE_NAME}
    container_name: cadvisor
    restart: unless-stopped
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg
    networks:
      - progcoder_network

  # =====================================
  # Tracing
  # =====================================

  otel-collector:
    image: ${OTEL_IMAGE_NAME}
    container_name: otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./config/otel-collector/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - ${OTEL_PPROF_PORT}:1888   # pprof extension
      - ${OTEL_PROMETHEUS_METRICS_PORT}:8888   # Prometheus metrics exposed by the collector
      - ${OTEL_PROMETHEUS_EXPORTER_PORT}:8889  # Prometheus exporter metrics
      - ${OTEL_HEALTH_PORT}:13133 # health_check extension
      - ${OTEL_OTLP_GRPC_PORT}:4317   # OTLP gRPC receiver
      - ${OTEL_ZPAGES_PORT}:55679 # zpages extension
    networks:
      - progcoder_network

  # =====================================
  # Logging
  # =====================================
  loki:
    image: ${LOKI_IMAGE_NAME}
    container_name: loki
    restart: unless-stopped
    ports:
      - ${LOKI_PORT}:3100
    volumes:
      - ./docker-volumes/loki:/loki
      - ./config/loki/loki-config.yml:/etc/loki/loki-config.yaml
    networks:
      - progcoder_network

  promtail:
    container_name: promtail
    image: ${PROMTAIL_IMAGE_NAME}
    command: -config.file=/etc/promtail/promtail-config.yml
    ports:
      - ${PROMTAIL_SYSLOG_PORT}:1514
      - ${PROMTAIL_HTTP_PORT}:9080
    restart: always
    volumes:
    - ./config/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
    networks:
      - progcoder_network

  tempo:
    image: ${TEMPO_IMAGE_NAME}
    container_name: tempo
    restart: unless-stopped
    ports:
      - ${TEMPO_HTTP_API_PORT}:3200
      # - ${TEMPO_OLTP_GRPC_PORT}:4317   # OTLP gRPC (ingest)
      # - ${TEMPO_OLTP_HTTP_PORT}:4318   # OTLP HTTP (ingest)
    volumes:
      - ./config/tempo/tempo.yaml:/etc/tempo/tempo.yaml
      - ./docker-volumes/tempo:/var/tempo
    command: [ "-config.file=/etc/tempo/tempo.yaml" ]
    networks:
      - progcoder_network

  # =====================================
  # Exporter
  # =====================================

  # =========================
  # Services - APIs
  # =========================
  
  catalog-api:
    build:
      context: .
      dockerfile: src/Services/Catalog/Api/Catalog.Api/Dockerfile
    container_name: catalog-api
    restart: unless-stopped 
    ports:
      - ${CATALOG_API_PORT}:8080
    depends_on:
      - postgres-sql
      - keycloak
      - minio
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  basket-api:
    build:
      context: .
      dockerfile: src/Services/Basket/Api/Basket.Api/Dockerfile
    container_name: basket-api
    restart: unless-stopped 
    ports:
      - ${BASKET_API_PORT}:8080
    depends_on:
      - mongodb
      - redis
      - keycloak
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  inventory-api:
    build:
      context: .
      dockerfile: src/Services/Inventory/Api/Inventory.Api/Dockerfile
    container_name: inventory-api
    restart: unless-stopped 
    ports:
      - ${INVENTORY_API_PORT}:8080
    depends_on:
      - mysql
      - keycloak
      - rabbitmq
      - minio
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  order-api:
    build:
      context: .
      dockerfile: src/Services/Order/Api/Order.Api/Dockerfile
    container_name: order-api
    restart: unless-stopped 
    ports:
      - ${ORDER_API_PORT}:8080
    depends_on:
      - sql-server
      - keycloak
      - rabbitmq
      - minio
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  discount-api:
    build:
      context: .
      dockerfile: src/Services/Discount/Api/Discount.Api/Dockerfile
    container_name: discount-api
    restart: unless-stopped 
    ports:
      - ${DISCOUNT_API_PORT}:8080
    depends_on:
      - mongodb
      - keycloak
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  notification-api:
    build:
      context: .
      dockerfile: src/Services/Notification/Api/Notification.Api/Dockerfile
    container_name: notification-api
    restart: unless-stopped 
    ports:
      - ${NOTIFICATION_API_PORT}:8080
    depends_on:
      - mongodb
      - keycloak
      - rabbitmq
      - minio
      - mailhog
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  search-api:
    build:
      context: .
      dockerfile: src/Services/Search/Api/Search.Api/Dockerfile
    container_name: search-api
    restart: unless-stopped 
    ports:
      - ${SEARCH_API_PORT}:8080
    depends_on:
      - elasticsearch
      - keycloak
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  report-api:
    build:
      context: .
      dockerfile: src/Services/Report/Api/Report.Api/Dockerfile
    container_name: report-api
    restart: unless-stopped 
    ports:
      - ${REPORT_API_PORT}:8080
    depends_on:
      - mongodb
      - keycloak
      - rabbitmq
      - minio
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  communication-api:
    build:
      context: .
      dockerfile: src/Services/Communication/Api/Communication.Api/Dockerfile
    container_name: communication-api
    restart: unless-stopped 
    ports:
      - ${COMMUNICATION_API_PORT}:8080
    depends_on:
      - keycloak
      - rabbitmq
      - otel-collector
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================
  # Services - gRPC Servers
  # =========================

  catalog-grpc:
    build:
      context: .
      dockerfile: src/Services/Catalog/Api/Catalog.Grpc/Dockerfile
    container_name: catalog-grpc
    restart: unless-stopped 
    ports:
      - ${CATALOG_GRPC_PORT}:8080
    depends_on:
      - postgres-sql
      - otel-collector
      - catalog-api
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  inventory-grpc:
    build:
      context: .
      dockerfile: src/Services/Inventory/Api/Inventory.Grpc/Dockerfile
    container_name: inventory-grpc
    restart: unless-stopped 
    ports:
      - ${INVENTORY_GRPC_PORT}:8080
    depends_on:
      - mysql
      - otel-collector
      - inventory-api
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  order-grpc:
    build:
      context: .
      dockerfile: src/Services/Order/Api/Order.Grpc/Dockerfile
    container_name: order-grpc
    restart: unless-stopped 
    ports:
      - ${ORDER_GRPC_PORT}:8080
    depends_on:
      - sql-server
      - otel-collector
      - order-api
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  discount-grpc:
    build:
      context: .
      dockerfile: src/Services/Discount/Api/Discount.Grpc/Dockerfile
    container_name: discount-grpc
    restart: unless-stopped 
    ports:
      - ${DISCOUNT_GRPC_PORT}:8080
    depends_on:
      - mongodb
      - otel-collector
      - discount-api
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  report-grpc:
    build:
      context: .
      dockerfile: src/Services/Report/Api/Report.Grpc/Dockerfile
    container_name: report-grpc
    restart: unless-stopped 
    ports:
      - ${REPORT_GRPC_PORT}:8080
    depends_on:
      - mongodb
      - otel-collector
      - report-api
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================
  # Workers - Outbox Pattern
  # =========================

  catalog-worker-outbox:
    build:
      context: .
      dockerfile: src/Services/Catalog/Worker/Catalog.Woker.Outbox/Dockerfile
    container_name: catalog-worker-outbox
    restart: unless-stopped
    depends_on:
      - postgres-sql
      - rabbitmq
      - minio
      - otel-collector
      - catalog-api
    networks:
      - progcoder_network

  basket-worker-outbox:
    build:
      context: .
      dockerfile: src/Services/Basket/Worker/Basket.Worker.Outbox/Dockerfile
    container_name: basket-worker-outbox
    restart: unless-stopped
    depends_on:
      - mongodb
      - rabbitmq
      - otel-collector
      - basket-api
    networks:
      - progcoder_network

  inventory-worker-outbox:
    build:
      context: .
      dockerfile: src/Services/Inventory/Worker/Inventory.Worker.Outbox/Dockerfile
    container_name: inventory-worker-outbox
    restart: unless-stopped
    depends_on:
      - mysql
      - rabbitmq
      - minio
      - otel-collector
      - inventory-api
    networks:
      - progcoder_network

  order-worker-outbox:
    build:
      context: .
      dockerfile: src/Services/Order/Worker/Order.Woker.Outbox/Dockerfile
    container_name: order-worker-outbox
    restart: unless-stopped
    depends_on:
      - sql-server
      - rabbitmq
      - minio
      - otel-collector
      - order-api
    networks:
      - progcoder_network

  # =========================
  # Workers - Consumers
  # =========================

  catalog-worker-consumer:
    build:
      context: .
      dockerfile: src/Services/Catalog/Worker/Catalog.Worker.Consumer/Dockerfile
    container_name: catalog-worker-consumer
    restart: unless-stopped
    depends_on:
      - postgres-sql
      - rabbitmq
      - minio
      - otel-collector
      - catalog-api
    networks:
      - progcoder_network

  inventory-worker-consumer:
    build:
      context: .
      dockerfile: src/Services/Inventory/Worker/Inventory.Worker.Consumer/Dockerfile
    container_name: inventory-worker-consumer
    restart: unless-stopped
    depends_on:
      - mysql
      - rabbitmq
      - minio
      - otel-collector
      - inventory-api
    networks:
      - progcoder_network

  order-worker-consumer:
    build:
      context: .
      dockerfile: src/Services/Order/Worker/Order.Worker.Consumer/Dockerfile
    container_name: order-worker-consumer
    restart: unless-stopped
    depends_on:
      - sql-server
      - rabbitmq
      - minio
      - otel-collector
      - order-api
    networks:
      - progcoder_network

  search-worker-consumer:
    build:
      context: .
      dockerfile: src/Services/Search/Worker/Search.Worker.Consumer/Dockerfile
    container_name: search-worker-consumer
    restart: unless-stopped
    depends_on:
      - elasticsearch
      - rabbitmq
      - otel-collector
      - search-api
    networks:
      - progcoder_network

  notification-worker-consumer:
    build:
      context: .
      dockerfile: src/Services/Notification/Worker/Notification.Worker.Consumer/Dockerfile
    container_name: notification-worker-consumer
    restart: unless-stopped
    depends_on:
      - mongodb
      - rabbitmq
      - minio
      - otel-collector
      - notification-api
    networks:
      - progcoder_network

  notification-worker-processor:
    build:
      context: .
      dockerfile: src/Services/Notification/Worker/Notification.Worker.Processor/Dockerfile
    container_name: notification-worker-processor
    restart: unless-stopped
    depends_on:
      - mongodb
      - rabbitmq
      - mailhog
      - otel-collector
      - notification-api
    networks:
      - progcoder_network

  # =========================
  # Job Orchestrator
  # =========================

  app-job:
    build:
      context: .
      dockerfile: src/JobOrchestrator/App.Job/Dockerfile
    container_name: app-job
    restart: unless-stopped
    depends_on:
      - keycloak
      - otel-collector
      - catalog-api
      - basket-api
      - inventory-api
      - order-api
      - discount-api
      - notification-api
      - search-api
      - report-api
      - communication-api
      - order-grpc
      - report-grpc
      - catalog-grpc
      - discount-grpc
      - inventory-grpc
    networks:
      - progcoder_network

  # =========================
  # API Gateway
  # =========================

  api-gateway:
    build:
      context: .
      dockerfile: src/ApiGateway/YarpApiGateway/Dockerfile
    container_name: api-gateway
    restart: unless-stopped 
    ports:
      - ${API_GATEWAY_PORT}:8080
    depends_on:
      - catalog-api
      - basket-api
      - inventory-api
      - order-api
      - discount-api
      - notification-api
      - search-api
      - report-api
      - communication-api
    networks:
      - progcoder_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  progcoder_network: